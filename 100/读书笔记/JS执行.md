# JS执行解密

## 一、JavaScript 代码的执行流程

一段 JavaScript 代码在执行之前需要被 JavaScript 引擎编译，并创建执行上下文，编译完成之后，才会进入执行阶 段。大致流程你可以参考下图：

![image-20200830140608530](E:\A极客时间\浏览器工作原理\JS执行.assets\image-20200830140608530.png)

### 1. 编译阶段

- 变量和函数会被存放到变量环境中，变量的默认值会被设置为 undefined

- 如果在编译阶段，存在两个相同的函数，那么最终存放在变量环境中的是最后定义的那 个，这是因为后定义的会覆盖掉之前定义的。

### 2. 执行阶段

- JavaScript 引擎会从变量环境中去查找自定义的变量和函数。

## 二、执行上下文

### **JS会创建执行上下文的情况**：

1. 当 JavaScript 执行全局代码的时候，会编译全局代码并创建全局执行上下文，而且在 整个页面的生存周期内，全局执行上下文只有一份。
2. 当**调用一个函数**的时候，函数体内的代码会被编译，并**创建函数执行上下文**，一般情况 下，函数执行结束之后，创建的函数执行上下文会被销毁。 
3. 当使用 eval 函数的时候，eval 的代码也会被编译，并创建执行上下文。

## 三、 调用栈

**含义**：调用栈就是用来管理函数调用关系的一种数据结构。

### 1. 函数调用

**函数调用**：就是运行一个函数，具体使用方式是使用函数名称跟着一对小括号。

执行 JavaScript 时，可能会存在多个执行上下文， JavaScript 引擎是通过一种叫栈的数据结构来管理的。

### 2. 栈结构

#### 什么是栈

类似于一端被堵住的单行线，车子类似于栈中的元素，栈中的元素满足后进先 出的特点。

#### 什么是 JavaScript 的调用栈

- JavaScript 引擎正是利用栈的这种结构来管理执行上下文的。
- 在执行上下文创建好后， JavaScript 引擎会将执行上下文压入栈中，通常把这种用来管理执行上下文的栈称为**执行上下文栈**，又称**调用栈**。
- **调用栈是 JavaScript 引擎追踪函数执行的一个机制**。

### 3. 开发中，如何利用好调用栈

#### 利用浏览器查看调用栈的信息

- 加入断点debugger，通过**Source查看调用栈**。

#### 栈溢出（Stack Overflow）

- 调用栈是有大小的，当入栈的执行上下文超过一定数目，JavaScript 引 擎就会报错，我们把这种错误叫做栈溢出。

## 四、总结

- 每调用一个函数，JavaScript 引擎会为其创建执行上下文，并把该执行上下文压入调用 栈，然后 JavaScript 引擎开始执行函数代码。
- 如果在一个函数 A 中调用了另外一个函数 B，那么 JavaScript 引擎会为 B 函数创建执行 上下文，并将 B 函数的执行上下文压入栈顶。
-  当前函数执行完毕后，JavaScript 引擎会将该函数的执行上下文弹出栈。 
- 当分配的调用栈空间被占满时，会引发“堆栈溢出”问题。